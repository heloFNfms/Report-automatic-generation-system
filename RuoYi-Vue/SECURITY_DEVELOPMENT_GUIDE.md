# 安全开发指南

## 概述
本文档总结了报告自动化生成系统的安全最佳实践和已修复的安全问题。

## 已修复的安全问题

### 1. XSS (跨站脚本攻击) 防护

#### 问题描述
- **高危**: 前端代码中直接使用 `v-html` 渲染用户输入或外部数据
- **影响文件**: 
  - `src/views/tool/gen/index.vue` - 代码预览功能中的 `highlightedCode` 方法
  - `src/views/system/report/wizard.vue` - 报告内容显示

#### 修复措施
1. **创建安全组件**: 实现了 `SafeHtml.vue` 组件，集成HTML净化功能
   - 支持 DOMPurify 库进行HTML净化
   - 提供基础净化函数作为备用方案
   - 可配置允许的HTML标签和属性

2. **替换不安全的v-html使用**:
   ```vue
   <!-- 修复前 (不安全) -->
   <div v-html="userContent"></div>
   
   <!-- 修复后 (安全) -->
   <SafeHtml :content="userContent" />
   ```

3. **移除危险的代码高亮功能**:
   - 移除了直接使用 `hljs.highlight` 结果的 `v-html` 渲染
   - 改用纯文本显示，避免XSS风险

### 2. API密钥安全管理

#### 问题描述
- **中危**: DeepSeek API密钥配置不当
- **影响**: 可能导致API密钥泄露或服务不可用

#### 修复措施
1. **统一环境变量管理**:
   - 所有API密钥仅通过环境变量配置
   - 移除硬编码密钥的可能性

2. **配置验证**:
   - 实现了 `validate_deepseek_config.py` 验证脚本
   - 自动检查API密钥配置的有效性

3. **错误处理和重试机制**:
   - 添加401错误的自动重试
   - 实现速率限制和退避策略

## 安全开发最佳实践

### 1. 前端安全

#### HTML内容渲染
- ✅ **推荐**: 使用 `SafeHtml` 组件渲染动态HTML内容
- ❌ **禁止**: 直接使用 `v-html` 渲染用户输入或外部数据
- ✅ **推荐**: 对于纯文本内容，使用 `v-text` 或插值语法 `{{ }}`

#### 用户输入验证
- 前端和后端都必须进行输入验证
- 使用白名单方式验证允许的HTML标签和属性
- 对特殊字符进行适当的转义

### 2. 后端安全

#### API密钥管理
- 所有敏感配置通过环境变量管理
- 不在代码中硬编码任何密钥或敏感信息
- 定期轮换API密钥

#### 错误处理
- 不在错误信息中暴露敏感信息
- 实现适当的重试和退避机制
- 记录安全相关的操作日志

### 3. 依赖管理

#### 安全库使用
- 前端: 推荐使用 DOMPurify 进行HTML净化
- 定期更新依赖库到最新安全版本
- 使用工具扫描已知的安全漏洞

## 安全检查清单

### 开发阶段
- [ ] 新增的HTML渲染是否使用了安全组件
- [ ] 用户输入是否经过适当验证和净化
- [ ] API密钥是否通过环境变量配置
- [ ] 错误处理是否避免信息泄露

### 部署阶段
- [ ] 环境变量是否正确配置
- [ ] 生产环境是否移除了调试信息
- [ ] HTTPS是否正确配置
- [ ] 安全头是否设置（CSP、HSTS等）

### 维护阶段
- [ ] 定期更新依赖库
- [ ] 定期轮换API密钥
- [ ] 监控安全相关的日志和告警
- [ ] 定期进行安全扫描

## 应急响应

### 发现安全问题时
1. 立即评估影响范围
2. 如果是高危问题，立即停止相关服务
3. 修复问题并进行测试
4. 更新本文档和相关流程
5. 通知相关人员

### 联系方式
- 安全问题报告: [安全团队邮箱]
- 紧急联系人: [紧急联系方式]

---

**最后更新**: 2024年12月
**版本**: 1.0
**维护者**: AI安全助手